// Ideas data - organized by month folders (Ideas)
const ideasData = [
    // Generado automáticamente - 2025-09-02T01:41:45.389274
    { name: "Reggaeton - Septiembre 2 - 2025", file: "Septiembre/Reggaeton - Septiembre 2 - 2025.mp3", genre: "septiembre", size: 1816541 },
    { name: "Trap - Agosto 31 - 2025 - Idea", file: "Agosto/Trap - Agosto 31 - 2025 - Idea.mp3", genre: "agosto", size: 826300 },
    { name: "Trap - Agosto 31 - 2025 - 2 - Idea", file: "Agosto/Trap - Agosto 31 - 2025 - 2 - Idea.mp3", genre: "agosto", size: 863264 },
    { name: "Beat 1 - House - Enero 20 - 2025", file: "Agosto/Beat 1 - House - Enero 20 - 2025.mp3", genre: "agosto", size: 2671680 },
    { name: "Reggaeton - Agosto 31 - 2025 - 2", file: "Agosto/Reggaeton - Agosto 31 - 2025 - 2.mp3", genre: "agosto", size: 1620222 },
    { name: "Idea 1 - Agosto 11 - 2025", file: "Agosto/Idea 1 - Agosto 11 - 2025.mp3", genre: "agosto", size: 3064320 },
    { name: "Idea 2 - Agosto 11 - 2025", file: "Agosto/Idea 2 - Agosto 11 - 2025.mp3", genre: "agosto", size: 3563520 },
    { name: "Boom Bap - Agosto 10 - 2025 - Idea", file: "Agosto/Boom Bap - Agosto 10 - 2025 - Idea.mp3", genre: "agosto", size: 3376320 },
    { name: "Reggaeton - Agosto 31 - 2025", file: "Agosto/Reggaeton - Agosto 31 - 2025.mp3", genre: "agosto", size: 1620218 },
    { name: "Skizo - Funk Boom Bap - Junio 20 - 2025", file: "Agosto/Skizo - Funk Boom Bap - Junio 20 - 2025.mp3", genre: "agosto", size: 3918720 }
];

// Beats data - organized by folder structure
const beats = [
    // Generado automáticamente - 2025-09-02T01:41:45.387579
    { name: "Beast Mode", file: "Drill/Beast Mode.mp3", genre: "drill", size: 3911720 },
    { name: "Risky", file: "Drill/Risky.mp3", genre: "drill", size: 5214915 },
    { name: "Scars", file: "Drill/Scars.mp3", genre: "drill", size: 3363075 },
    { name: "Cuerno", file: "Drill/Cuerno.mp3", genre: "drill", size: 2862916 },
    { name: "Ashes", file: "Dark Boom Bap/Ashes.mp3", genre: "dark-boom-bap", size: 4069155 },
    { name: "Stolas", file: "Dark Boom Bap/Stolas.mp3", genre: "dark-boom-bap", size: 4858276 },
    { name: "Gargola", file: "Dark Boom Bap/Gargola.mp3", genre: "dark-boom-bap", size: 4323077 },
    { name: "Infinite Labyrinth", file: "Dark Boom Bap/Infinite Labyrinth.mp3", genre: "dark-boom-bap", size: 3939088 },
    { name: "Quimico", file: "Dark Boom Bap/Quimico.mp3", genre: "dark-boom-bap", size: 4323077 },
    { name: "Dracula", file: "Dark Boom Bap/Dracula.mp3", genre: "dark-boom-bap", size: 3993797 },
    { name: "Ouroboros", file: "Dark Boom Bap/Ouroboros.mp3", genre: "dark-boom-bap", size: 3495079 },
    { name: "True Grit", file: "Dark Boom Bap/True Grit.mp3", genre: "dark-boom-bap", size: 4259239 },
    { name: "Dangerous", file: "Dark Boom Bap/Dangerous.mp3", genre: "dark-boom-bap", size: 4195399 },
    { name: "Monster", file: "Dark Boom Bap/Monster.mp3", genre: "dark-boom-bap", size: 4291397 },
    { name: "Viaje", file: "Dark Boom Bap/Viaje.mp3", genre: "dark-boom-bap", size: 4108035 },
    { name: "Problema", file: "Dark Boom Bap/Problema.mp3", genre: "dark-boom-bap", size: 3843078 },
    { name: "7 Kilos", file: "Dark Boom Bap/7 Kilos.mp3", genre: "dark-boom-bap", size: 4291397 },
    { name: "Engulfed By Madness", file: "Dark Boom Bap/Engulfed By Madness.mp3", genre: "dark-boom-bap", size: 3814289 },
    { name: "Sol Negro", file: "Dark Boom Bap/Sol Negro.mp3", genre: "dark-boom-bap", size: 3420199 },
    { name: "Magia", file: "Dark Boom Bap/Magia.mp3", genre: "dark-boom-bap", size: 4226115 },
    { name: "Beast", file: "Dark Boom Bap/Beast.mp3", genre: "dark-boom-bap", size: 3730755 },
    { name: "Cerberus", file: "Dark Boom Bap/Cerberus.mp3", genre: "dark-boom-bap", size: 4417158 },
    { name: "Subconscious", file: "Dark Boom Bap/Subconscious.mp3", genre: "dark-boom-bap", size: 4408042 },
    { name: "Demente", file: "Dark Boom Bap/Demente.mp3", genre: "dark-boom-bap", size: 2708357 },
    { name: "Rage", file: "Dark Boom Bap/Rage.mp3", genre: "dark-boom-bap", size: 4218914 },
    { name: "Legacy", file: "Dark Boom Bap/Legacy.mp3", genre: "dark-boom-bap", size: 4096516 },
    { name: "Transdimensional Picnic", file: "Dark Boom Bap/Transdimensional Picnic.mp3", genre: "dark-boom-bap", size: 4132533 },
    { name: "Belial", file: "Dark Boom Bap/Belial.mp3", genre: "dark-boom-bap", size: 3690916 },
    { name: "Ice Box", file: "Dark Boom Bap/Ice Box.mp3", genre: "dark-boom-bap", size: 4304837 },
    { name: "Tinta Negra", file: "Dark Boom Bap/Tinta Negra.mp3", genre: "dark-boom-bap", size: 4242441 },
    { name: "Roto", file: "Dark Boom Bap/Roto.mp3", genre: "dark-boom-bap", size: 3903074 },
    { name: "Expanded Perception", file: "Dark Boom Bap/Expanded Perception.mp3", genre: "dark-boom-bap", size: 4536689 },
    { name: "Maldito", file: "Dark Boom Bap/Maldito.mp3", genre: "dark-boom-bap", size: 4499717 },
    { name: "Bizarre Dream", file: "Dark Boom Bap/Bizarre Dream.mp3", genre: "dark-boom-bap", size: 4269803 },
    { name: "Ritual Night", file: "Dark Boom Bap/Ritual Night.mp3", genre: "dark-boom-bap", size: 4291402 },
    { name: "Joker", file: "Dark Boom Bap/Joker.mp3", genre: "dark-boom-bap", size: 3120195 },
    { name: "Illusion of Choice", file: "Dark Boom Bap/Illusion of Choice.mp3", genre: "dark-boom-bap", size: 4203088 },
    { name: "Blood Stain", file: "Dark Boom Bap/Blood Stain.mp3", genre: "dark-boom-bap", size: 3894441 },
    { name: "Ethereal Illusions", file: "Dark Boom Bap/Ethereal Illusions.mp3", genre: "dark-boom-bap", size: 4744528 },
    { name: "Diamond Cut", file: "Dark Boom Bap/Diamond Cut.mp3", genre: "dark-boom-bap", size: 3858441 },
    { name: "Walking Through Chaos", file: "Dark Boom Bap/Walking Through Chaos.mp3", genre: "dark-boom-bap", size: 3956371 },
    { name: "Smoke", file: "Dark Boom Bap/Smoke.mp3", genre: "dark-boom-bap", size: 3926115 },
    { name: "Most Wanted", file: "Dark Boom Bap/Most Wanted.mp3", genre: "dark-boom-bap", size: 3663561 },
    { name: "Void", file: "Dark Boom Bap/Void.mp3", genre: "dark-boom-bap", size: 4447394 },
    { name: "Smoke - Griselda", file: "Dark Boom Bap/Smoke - Griselda.mp3", genre: "dark-boom-bap", size: 4622606 },
    { name: "Mente Rota", file: "Dark Boom Bap/Mente Rota.mp3", genre: "dark-boom-bap", size: 3961160 },
    { name: "Noche", file: "Dark Boom Bap/Noche.mp3", genre: "dark-boom-bap", size: 4247235 },
    { name: "Clandestine", file: "Dark Boom Bap/Clandestine.mp3", genre: "dark-boom-bap", size: 3903081 },
    { name: "Night Light", file: "Dark Boom Bap/Night Light.mp3", genre: "dark-boom-bap", size: 3624681 },
    { name: "From The Darkness", file: "Dark Boom Bap/From The Darkness.mp3", genre: "dark-boom-bap", size: 4283247 },
    { name: "Medusa", file: "Dark Boom Bap/Medusa.mp3", genre: "dark-boom-bap", size: 4281316 },
    { name: "Furious", file: "Dark Boom Bap/Furious.mp3", genre: "dark-boom-bap", size: 2930117 },
    { name: "Flota", file: "Dark Boom Bap/Flota.mp3", genre: "dark-boom-bap", size: 4059075 },
    { name: "Robbery", file: "Dark Boom Bap/Robbery.mp3", genre: "dark-boom-bap", size: 4298117 },
    { name: "Abnormal Thoughts", file: "Dark Boom Bap/Abnormal Thoughts.mp3", genre: "dark-boom-bap", size: 4940367 },
    { name: "Melting Mind", file: "Dark Boom Bap/Melting Mind.mp3", genre: "dark-boom-bap", size: 4205482 },
    { name: "Ketamine", file: "Dark Boom Bap/Ketamine.mp3", genre: "dark-boom-bap", size: 4003398 },
    { name: "Basilisco", file: "Dark Boom Bap/Basilisco.mp3", genre: "dark-boom-bap", size: 4189159 },
    { name: "Mad", file: "Dark Boom Bap/Mad.mp3", genre: "dark-boom-bap", size: 3858433 },
    { name: "Infinite Dream", file: "Dark Boom Bap/Infinite Dream.mp3", genre: "dark-boom-bap", size: 3521004 },
    { name: "Money In Hand", file: "Dark Boom Bap/Money In Hand.mp3", genre: "dark-boom-bap", size: 3683243 },
    { name: "Final Boss", file: "Dark Boom Bap/Final Boss.mp3", genre: "dark-boom-bap", size: 4031240 },
    { name: "Haze", file: "Dark Boom Bap/Haze.mp3", genre: "dark-boom-bap", size: 3443714 },
    { name: "Cursed", file: "Dark Boom Bap/Cursed.mp3", genre: "dark-boom-bap", size: 4947556 },
    { name: "Millitia", file: "Dark Boom Bap/Millitia.mp3", genre: "dark-boom-bap", size: 3157638 },
    { name: "Ya se la Saben", file: "Dark Boom Bap/Ya se la Saben.mp3", genre: "dark-boom-bap", size: 3992844 },
    { name: "Ain't Easy", file: "Dark Boom Bap/Ain't Easy.mp3", genre: "dark-boom-bap", size: 3854600 },
    { name: "Hallucinations", file: "Dark Boom Bap/Hallucinations.mp3", genre: "dark-boom-bap", size: 3550284 },
    { name: "illuminati", file: "Dark Boom Bap/illuminati.mp3", genre: "dark-boom-bap", size: 3783080 },
    { name: "Headshot", file: "Dark Boom Bap/Headshot.mp3", genre: "dark-boom-bap", size: 4735878 },
    { name: "Dark Knight", file: "Dark Boom Bap/Dark Knight.mp3", genre: "dark-boom-bap", size: 4311081 },
    { name: "100k Stack", file: "Dark Boom Bap/100k Stack.mp3", genre: "dark-boom-bap", size: 4003400 },
    { name: "Pensamientos", file: "Dark Boom Bap/Pensamientos.mp3", genre: "dark-boom-bap", size: 3895402 },
    { name: "Night Plan", file: "Dark Boom Bap/Night Plan.mp3", genre: "dark-boom-bap", size: 3647720 },
    { name: "Voices on My Head", file: "Dark Boom Bap/Voices on My Head.mp3", genre: "dark-boom-bap", size: 4125807 },
    { name: "Andromeda", file: "Dark Boom Bap/Andromeda.mp3", genre: "dark-boom-bap", size: 4621159 },
    { name: "Orias", file: "Dark Boom Bap/Orias.mp3", genre: "dark-boom-bap", size: 4159395 },
    { name: "Moloc", file: "Dark Boom Bap/Moloc.mp3", genre: "dark-boom-bap", size: 3946755 },
    { name: "Ira", file: "Dark Boom Bap/Ira.mp3", genre: "dark-boom-bap", size: 4603393 },
    { name: "Uncut Lines", file: "Dark Boom Bap/Uncut Lines.mp3", genre: "dark-boom-bap", size: 3792681 },
    { name: "Ares", file: "Dark Boom Bap/Ares.mp3", genre: "dark-boom-bap", size: 3246434 },
    { name: "Phantom Shadow", file: "Dark Boom Bap/Phantom Shadow.mp3", genre: "dark-boom-bap", size: 3097164 },
    { name: "3 Gramos", file: "Dark Boom Bap/3 Gramos.mp3", genre: "dark-boom-bap", size: 4217958 },
    { name: "UFO Ride", file: "Dark Boom Bap/UFO Ride.mp3", genre: "dark-boom-bap", size: 4033638 },
    { name: "Not Easy", file: "Dark Boom Bap/Not Easy.mp3", genre: "dark-boom-bap", size: 4180518 },
    { name: "Machiavelli", file: "Dark Boom Bap/Machiavelli.mp3", genre: "dark-boom-bap", size: 4181961 },
    { name: "Mysterious-Force", file: "Dark Boom Bap/Mysterious-Force.mp3", genre: "dark-boom-bap", size: 4003406 },
    { name: "Witchcraft", file: "Dark Boom Bap/Witchcraft.mp3", genre: "dark-boom-bap", size: 3799400 },
    { name: "Dark Boom Bap - Void", file: "Dark Boom Bap/Dark Boom Bap - Void.mp3", genre: "dark-boom-bap", size: 4203090 },
    { name: "At Night", file: "Boom Bap/At Night.mp3", genre: "boom-bap", size: 3654918 },
    { name: "Villain", file: "Boom Bap/Villain.mp3", genre: "boom-bap", size: 3975557 },
    { name: "Hard Life", file: "Boom Bap/Hard Life.mp3", genre: "boom-bap", size: 3637639 },
    { name: "No Sleep", file: "Boom Bap/No Sleep.mp3", genre: "boom-bap", size: 4108518 },
    { name: "Dark Times", file: "Boom Bap/Dark Times.mp3", genre: "boom-bap", size: 3353960 },
    { name: "Fate", file: "Boom Bap/Fate.mp3", genre: "boom-bap", size: 3007394 },
    { name: "Impala", file: "Boom Bap/Impala.mp3", genre: "boom-bap", size: 3129796 },
    { name: "Raw Play", file: "Boom Bap/Raw Play.mp3", genre: "boom-bap", size: 3317478 },
    { name: "El Barrio", file: "Boom Bap/El Barrio.mp3", genre: "boom-bap", size: 3664039 },
    { name: "Mind State", file: "Boom Bap/Mind State.mp3", genre: "boom-bap", size: 3724520 },
    { name: "Reflection", file: "Boom Bap/Reflection.mp3", genre: "boom-bap", size: 3683240 },
    { name: "Heaven And Hell", file: "Boom Bap/Heaven And Hell.mp3", genre: "boom-bap", size: 4501165 },
    { name: "Midnight", file: "Boom Bap/Midnight.mp3", genre: "boom-bap", size: 3880038 },
    { name: "King", file: "Boom Bap/King.mp3", genre: "boom-bap", size: 2612834 },
    { name: "Gucci", file: "Boom Bap/Gucci.mp3", genre: "boom-bap", size: 4249635 },
    { name: "Echoes of Yesterday", file: "Boom Bap/Echoes of Yesterday.mp3", genre: "boom-bap", size: 3904529 },
    { name: "Faded Page", file: "Boom Bap/Faded Page.mp3", genre: "boom-bap", size: 3886280 },
    { name: "Cashing Out", file: "Boom Bap/Cashing Out.mp3", genre: "boom-bap", size: 3686601 },
    { name: "Block Party Blues", file: "Boom Bap/Block Party Blues.mp3", genre: "boom-bap", size: 4389327 },
    { name: "Unidentified Encounters", file: "Boom Bap/Unidentified Encounters.mp3", genre: "boom-bap", size: 3917013 },
    { name: "Glizzy", file: "Trap/Glizzy.mp3", genre: "trap", size: 2943076 },
    { name: "Lil Baby - No Sleep", file: "Trap/Lil Baby - No Sleep.mp3", genre: "trap", size: 2781329 },
    { name: "R.I.C.O.", file: "Trap/R.I.C.O..mp3", genre: "trap", size: 2998278 },
    { name: "Not Luck", file: "Trap/Not Luck.mp3", genre: "trap", size: 2762598 },
    { name: "Never Stopping", file: "Trap/Never Stopping.mp3", genre: "trap", size: 4069389 },
    { name: "Extra Hours", file: "Trap/Extra Hours.mp3", genre: "trap", size: 3276201 },
    { name: "Worst Without me", file: "Trap/Worst Without me.mp3", genre: "trap", size: 2847566 },
    { name: "My Turn", file: "Trap/My Turn.mp3", genre: "trap", size: 3299717 },
    { name: "24_7", file: "Trap/24_7.mp3", genre: "trap", size: 3399600 },
    { name: "Airport", file: "Trap/Airport.mp3", genre: "trap", size: 3057797 },
    { name: "Special Ops", file: "Trap/Special Ops.mp3", genre: "trap", size: 3315081 },
    { name: "Heat", file: "Trap/Heat.mp3", genre: "trap", size: 2563681 },
    { name: "Top Dog", file: "Trap/Top Dog.mp3", genre: "trap", size: 2883077 },
    { name: "Tiktok", file: "Trap/Tiktok.mp3", genre: "trap", size: 3386116 },
    { name: "Marching Flute", file: "Trap/Marching Flute.mp3", genre: "trap", size: 3603084 },
    { name: "Diamond", file: "Trap/Diamond.mp3", genre: "trap", size: 3283397 },
    { name: "Never Look Back", file: "Trap/Never Look Back.mp3", genre: "trap", size: 3548845 },
    { name: "Telepathy", file: "Trap/Telepathy.mp3", genre: "trap", size: 3449479 },
    { name: "Honey", file: "Trap/Honey.mp3", genre: "trap", size: 3411075 },
    { name: "300", file: "Trap/300.mp3", genre: "trap", size: 2694433 },
    { name: "Account", file: "Trap/Account.mp3", genre: "trap", size: 3400037 },
    { name: "Incantations", file: "Trap/Incantations.mp3", genre: "trap", size: 3742282 },
    { name: "Turbo", file: "Trap/Turbo.mp3", genre: "trap", size: 3660675 },
    { name: "Demons", file: "Trap/Demons.mp3", genre: "trap", size: 3547876 },
    { name: "Jupiter", file: "Trap/Jupiter.mp3", genre: "trap", size: 3203237 },
    { name: "Memories", file: "Electronic/Memories.mp3", genre: "electronic", size: 3256998 },
    { name: "Rizz", file: "Electronic/Rizz.mp3", genre: "electronic", size: 3187874 },
    { name: "Sueños", file: "Electronic/Sueños.mp3", genre: "electronic", size: 4186767 },
    { name: "Discover You", file: "Electronic/Discover You.mp3", genre: "electronic", size: 4841482 },
    { name: "Break You", file: "Rock/Break You.mp3", genre: "rock", size: 4241479 },
    { name: "FLXN", file: "Rage/FLXN.mp3", genre: "rage", size: 2340194 },
    { name: "IDKY", file: "Rage/IDKY.mp3", genre: "rage", size: 2813954 },
    { name: "SHXT", file: "Rage/SHXT.mp3", genre: "rage", size: 2340194 },
    { name: "Nascar", file: "Rage/Nascar.mp3", genre: "rage", size: 2847556 },
    { name: "Can't Do This", file: "Rage/Can't Do This.mp3", genre: "rage", size: 3441405 },
    { name: "Historia", file: "Reggaeton/Historia.mp3", genre: "reggaeton", size: 3742278 },
    { name: "Recuerdo", file: "Reggaeton/Recuerdo.mp3", genre: "reggaeton", size: 4148838 },
    { name: "Regresa", file: "Reggaeton/Regresa.mp3", genre: "reggaeton", size: 4643237 },
    { name: "Otro Numero", file: "Reggaeton/Otro Numero.mp3", genre: "reggaeton", size: 3655401 },
    { name: "Olvidarte", file: "Reggaeton/Olvidarte.mp3", genre: "reggaeton", size: 3950119 },
    { name: "Conocida", file: "Reggaeton/Conocida.mp3", genre: "reggaeton", size: 3616038 }
];

// Map Boom Bap -> Dark Boom Bap if file was moved
// List of filenames present in `MP3/Dark Boom Bap/`
const DARK_BOOM_BAP_FILES = new Set([
    "Ashes.mp3","Stolas.mp3","Gargola.mp3","Infinite Labyrinth.mp3","Quimico.mp3","Dracula.mp3","Ouroboros.mp3","True Grit.mp3","Dangerous.mp3","Monster.mp3","Viaje.mp3","Problema.mp3","7 Kilos.mp3","Engulfed By Madness.mp3","Sol Negro.mp3","Magia.mp3","Beast.mp3","Cerberus.mp3","Subconscious.mp3","Demente.mp3","Rage.mp3","Legacy.mp3","Transdimensional Picnic.mp3","Belial.mp3","Ice Box.mp3","Tinta Negra.mp3","Roto.mp3","Expanded Perception.mp3","Maldito.mp3","Bizarre Dream.mp3","Ritual Night.mp3","Joker.mp3","Illusion of Choice.mp3","Blood Stain.mp3","Ethereal Illusions.mp3","Diamond Cut.mp3","Walking Through Chaos.mp3","Smoke.mp3","Most Wanted.mp3","Void.mp3","Smoke - Griselda.mp3","Mente Rota.mp3","Noche.mp3","Clandestine.mp3","Night Light.mp3","From The Darkness.mp3","Medusa.mp3","Furious.mp3","Flota.mp3","Robbery.mp3","Abnormal Thoughts.mp3","Melting Mind.mp3","Ketamine.mp3","Basilisco.mp3","Mad.mp3","Infinite Dream.mp3","Money In Hand.mp3","Final Boss.mp3","Haze.mp3","Cursed.mp3","Millitia.mp3","Ya se la Saben.mp3","Ain't Easy.mp3","Hallucinations.mp3","illuminati.mp3","Headshot.mp3","Dark Knight.mp3","100k Stack.mp3","Pensamientos.mp3","Night Plan.mp3","Voices on My Head.mp3","Andromeda.mp3","Orias.mp3","Moloc.mp3","Ira.mp3","Uncut Lines.mp3","Ares.mp3","Phantom Shadow.mp3","3 Gramos.mp3","UFO Ride.mp3","Not Easy.mp3","Machiavelli.mp3","Mysterious-Force.mp3","Witchcraft.mp3","Dark Boom Bap - Void.mp3"
]);

// Normalize beats: if a Boom Bap file is now under Dark Boom Bap, update its path and genre
for (const beat of beats) {
    if (typeof beat.file === 'string' && beat.file.startsWith('Boom Bap/')) {
        const base = beat.file.substring('Boom Bap/'.length);
        if (DARK_BOOM_BAP_FILES.has(base)) {
            beat.file = `Dark Boom Bap/${base}`;
            beat.genre = 'dark-boom-bap';
        }
    }
}

// Helper to safely encode URL paths (handles spaces, accents like ñ, etc.)
function encodePath(p) {
    if (typeof p !== 'string') return '';
    return p.split('/').map(encodeURIComponent).join('/');
}

// Global build token for cache-busting (provided by index.html loader)
const BUILD_TOKEN = (typeof window !== 'undefined' && window.__BUILD_VERSION) ? String(window.__BUILD_VERSION) : Date.now().toString();

// Global variables
let currentMode = 'beats'; // 'beats' or 'ideas'
let currentData = beats;
let currentBeatIndex = 0;
let isPlaying = false;
let filteredBeats = [...beats];
let audioElement = document.getElementById('audioElement');
let currentSort = 'default'; // 'default' | 'random' | 'az' | 'za' | 'newest' | 'oldest'

// Duration metadata loading control
const durationCache = new Map(); // key: file path, value: seconds (number)
let metadataConcurrency = 0;
const MAX_METADATA_CONCURRENCY = 2;
const durationQueue = []; // queue of { file, element, mode }
const pendingDurationAudios = new Set(); // active Audio objects for cancellation

// Lazy rendering & metadata observers
const PAGE_SIZE = 150;
let renderOffset = 0;
let durationObserver = null;
let sentinelObserver = null;
// Infinite scroll sentinel element
const infiniteSentinel = document.createElement('div');
infiniteSentinel.style.height = '1px';

// DOM elements
const modeSwitch = document.getElementById('modeSwitch');
const genreHeader = document.getElementById('genreHeader');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const currentTrack = document.getElementById('currentTrack');
const currentTime = document.getElementById('currentTime');
const duration = document.getElementById('duration');
const progress = document.getElementById('progress');
const progressBar = document.querySelector('.progress-bar');
const volumeSlider = document.getElementById('volumeSlider');
const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const sortOrder = document.getElementById('sortOrder');
// const itemCount = document.getElementById('itemCount'); // Removed
const beatsContainer = document.getElementById('beatsContainer');
const loading = document.getElementById('loading');
const searchToggle = document.getElementById('searchToggle');
const searchOverlay = document.getElementById('searchOverlay');
const searchClose = document.getElementById('searchClose');
const helpToggle = document.getElementById('helpToggle');
// Download modal elements
const downloadBtn = document.getElementById('downloadBtn');
const downloadModal = document.getElementById('downloadModal');
const downloadClose = document.getElementById('downloadClose');
const downloadEmail = document.getElementById('downloadEmail');
const downloadConsent = document.getElementById('downloadConsent');
const getBeatBtn = document.getElementById('getBeatBtn');

// Cloud Function endpoint to save email
// POST JSON: { email: string }
const CLOUD_FUNCTION_URL = 'https://anibal-kitchen-mail-239123017172.northamerica-south1.run.app';

// AddedAt map for newest/oldest sorting (extend as needed)
// Use numeric timestamps for easy comparison
const ADDED_AT = new Map([
    ['Dark Boom Bap/Demente.mp3', 20250818223106],
    ['Dark Boom Bap/Maldito.mp3', 20250818223106],
    ['Dark Boom Bap/Sol Negro.mp3', 20250818223106]
]);

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    // place sentinel after list container
    if (beatsContainer && beatsContainer.parentNode) {
        beatsContainer.parentNode.appendChild(infiniteSentinel);
    }
    createObservers();
    renderBeats();
    setupEventListeners();
    loading.style.display = 'none';
});

// Render beats list
function renderBeats() {
    // Reset container and state
    beatsContainer.innerHTML = '';
    renderOffset = 0;
    // Render first batch
    renderNextBatch();
}

function renderNextBatch() {
    const slice = filteredBeats.slice(renderOffset, renderOffset + PAGE_SIZE);
    slice.forEach((beat) => {
        const beatRow = document.createElement('div');
        beatRow.className = 'beat-row';
        const beatIndex = currentData.indexOf(beat);
        beatRow.innerHTML = `
            <div class="beat-title">${beat.name}</div>
            ${(() => { 
                const g = beat.file && beat.file.startsWith('Dark Boom Bap/') ? 'dark-boom-bap' : beat.genre; 
                const l = g === 'boom-bap' ? 'Boom Bap' : (g === 'dark-boom-bap' ? 'Dark Boom Bap' : g);
                return `<div class=\"beat-genre ${g}\">${l}</div>`; 
            })()}
            <div class="beat-duration" data-file="${beat.file}">—</div>
            <div class="beat-size">${formatFileSize(beat.size)}</div>
            <button class="beat-play-btn" onclick="playBeat(${beatIndex})">
                <i class="fas fa-play"></i>
            </button>
        `;
        beatsContainer.appendChild(beatRow);
        const durEl = beatRow.querySelector('.beat-duration');
        if (durationObserver && durEl) durationObserver.observe(durEl);
    });
    renderOffset += slice.length;
    // Manage sentinel
    if (renderOffset < filteredBeats.length) {
        if (sentinelObserver) sentinelObserver.observe(infiniteSentinel);
    } else {
        if (sentinelObserver) sentinelObserver.unobserve(infiniteSentinel);
    }
}

function createObservers() {
    // Observer for durations (lazy load when visible)
    if (durationObserver) durationObserver.disconnect();
    durationObserver = new IntersectionObserver((entries) => {
        for (const entry of entries) {
            if (entry.isIntersecting) {
                const el = entry.target;
                const file = el && el.getAttribute('data-file');
                if (file) {
                    loadBeatDuration(file, el);
                }
                durationObserver.unobserve(el);
            }
        }
    }, { root: null, rootMargin: '200px 0px', threshold: 0.01 });

    // Observer for infinite scroll sentinel
    if (sentinelObserver) sentinelObserver.disconnect();
    sentinelObserver = new IntersectionObserver((entries) => {
        for (const entry of entries) {
            if (entry.isIntersecting) {
                renderNextBatch();
            }
        }
    }, { root: null, rootMargin: '400px 0px', threshold: 0 });
}

// Load beat duration
function loadBeatDuration(file, element) {
    // If cached, use it immediately
    if (durationCache.has(file)) {
        const seconds = durationCache.get(file);
        element.textContent = formatTime(seconds);
        return;
    }

    // Enqueue task; include mode to build correct folder path when executed
    durationQueue.push({ file, element, mode: currentMode });
    processDurationQueue();
}

function processDurationQueue() {
    while (metadataConcurrency < MAX_METADATA_CONCURRENCY && durationQueue.length > 0) {
        const task = durationQueue.shift();
        const { file, element, mode } = task;

        // If element no longer exists in DOM, skip
        if (!element || !document.body.contains(element)) continue;

        metadataConcurrency++;
        const folderPath = mode === 'beats' ? 'MP3' : 'Ideas';
        let attemptedAlt = false;
        let audio = new Audio(encodePath(`${folderPath}/${file}`) + `?v=${BUILD_TOKEN}`);
        pendingDurationAudios.add(audio);

        const cleanup = () => {
            pendingDurationAudios.delete(audio);
            metadataConcurrency = Math.max(0, metadataConcurrency - 1);
            processDurationQueue();
        };

        audio.addEventListener('loadedmetadata', function() {
            durationCache.set(file, audio.duration);
            if (document.body.contains(element)) {
                element.textContent = formatTime(audio.duration);
            }
            cleanup();
        }, { once: true });

        // Fallback: if Boom Bap path fails, try Dark Boom Bap
        audio.addEventListener('error', function onErr() {
            if (!attemptedAlt && typeof file === 'string' && file.startsWith('Boom Bap/')) {
                attemptedAlt = true;
                audio.removeEventListener('error', onErr);
                const altFile = file.replace('Boom Bap/', 'Dark Boom Bap/');
                audio = new Audio(encodePath(`${folderPath}/${altFile}`) + `?v=${BUILD_TOKEN}`);
                pendingDurationAudios.add(audio);
                audio.addEventListener('loadedmetadata', function() {
                    durationCache.set(file, audio.duration);
                    if (document.body.contains(element)) {
                        element.textContent = formatTime(audio.duration);
                    }
                    cleanup();
                }, { once: true });
                audio.addEventListener('error', () => {
                    if (document.body.contains(element)) {
                        element.textContent = '0:00';
                    }
                    cleanup();
                }, { once: true });
                audio.load();
                return;
            }
            if (document.body.contains(element)) {
                element.textContent = '0:00';
            }
            cleanup();
        }, { once: true });

        audio.load();
    }
}

// Play specific beat (with toggle functionality)
function playBeat(index) {
    // If the same beat is already playing, toggle pause/play
    if (currentBeatIndex === index && audioElement.src && !audioElement.src.includes('blob:') && currentBeatIndex >= 0) {
        if (isPlaying) {
            // Pause the current track
            audioElement.pause();
            isPlaying = false;
        } else {
            // Resume the current track
            audioElement.play().then(() => {
                isPlaying = true;
                updatePlayButton();
                updateBeatCards();
            }).catch(error => {
                console.error('Error resuming audio:', error);
                currentTrack.textContent = 'Error resuming audio file';
                isPlaying = false;
                updatePlayButton();
            });
        }
        updatePlayButton();
        updateBeatCards();
        return;
    }
    
    // Play a new beat
    currentBeatIndex = index;
    const beat = currentData[currentBeatIndex];
    const folderPath = currentMode === 'beats' ? 'MP3' : 'Ideas';
    
    // Primary source
    let primaryPath = encodePath(`${folderPath}/${beat.file}`) + `?v=${BUILD_TOKEN}`;
    let triedAlt = false;
    audioElement.src = primaryPath;
    audioElement.load();

    currentTrack.textContent = beat.name;
    updatePlayingState();
    
    const tryPlay = () => audioElement.play().then(() => {
        isPlaying = true;
        updatePlayButton();
        updateBeatCards();
    }).catch(error => {
        // Fallback: try Dark Boom Bap if Boom Bap path fails
        if (!triedAlt && typeof beat.file === 'string' && beat.file.startsWith('Boom Bap/')) {
            triedAlt = true;
            const altPath = encodePath(`${folderPath}/${beat.file.replace('Boom Bap/', 'Dark Boom Bap/')}`) + `?v=${BUILD_TOKEN}`;
            audioElement.src = altPath;
            audioElement.load();
            return tryPlay();
        }
        console.error('Error playing audio:', error);
        currentTrack.textContent = 'Error loading audio file';
        isPlaying = false;
        updatePlayButton();
    });
    tryPlay();
}

// Setup event listeners
function setupEventListeners() {
    // Mode switch
    if (modeSwitch) {
        modeSwitch.addEventListener('change', toggleMode);
    }
    
    // Player controls
    playBtn.addEventListener('click', togglePlay);
    prevBtn.addEventListener('click', previousBeat);
    nextBtn.addEventListener('click', nextBeat);
    
    // Audio events
    audioElement.addEventListener('timeupdate', updateProgress);
    audioElement.addEventListener('loadedmetadata', updateDuration);
    audioElement.addEventListener('ended', nextBeat);
    
    // Progress bar
    progressBar.addEventListener('click', seekAudio);
    
    // Volume control
    volumeSlider.addEventListener('input', updateVolume);
    audioElement.volume = volumeSlider.value / 100;
    
    // Search functionality
    searchToggle.addEventListener('click', openSearch);
    searchClose.addEventListener('click', closeSearch);
    searchInput.addEventListener('input', filterBeats);
    
    // Help functionality
    if (helpToggle) {
        helpToggle.addEventListener('click', function() {
            window.location.href = 'help.html';
        });
    }
    
    // Sorting functionality
    if (sortOrder) {
        sortOrder.addEventListener('change', function() {
            currentSort = sortOrder.value || 'default';
            // Re-apply sorting on current filtered set
            applySort();
            renderBeats();
        });
    }
    
    // Download modal functionality
    if (downloadBtn && downloadModal) {
        downloadBtn.addEventListener('click', openDownloadModal);
    }
    if (downloadClose) {
        downloadClose.addEventListener('click', closeDownloadModal);
    }
    if (downloadModal) {
        downloadModal.addEventListener('click', function(e) {
            if (e.target === downloadModal) closeDownloadModal();
        });
    }
    if (getBeatBtn) {
        getBeatBtn.addEventListener('click', handleGetBeatClick);
    }
    
    // Close search on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && searchOverlay.classList.contains('active')) {
            closeSearch();
        }
        if (e.key === 'Escape' && downloadModal && downloadModal.classList.contains('active')) {
            closeDownloadModal();
        }
    });
    
    // Close search when clicking outside
    searchOverlay.addEventListener('click', function(e) {
        if (e.target === searchOverlay) {
            closeSearch();
        }
    });
    
    // Filter
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterBeats);
    }
}

// Toggle play/pause
function togglePlay() {
    if (audioElement.src) {
        if (isPlaying) {
            audioElement.pause();
            isPlaying = false;
        } else {
            audioElement.play();
            isPlaying = true;
        }
        updatePlayButton();
    } else if (currentData.length > 0) {
        playBeat(0);
    }
}

// Previous beat
function previousBeat() {
    // Use filtered list for navigation
    const list = filteredBeats && filteredBeats.length ? filteredBeats : currentData;
    if (!list.length) return; // nothing to play

    // Find current position within the filtered list
    const currentInFiltered = list.findIndex(b => currentData.indexOf(b) === currentBeatIndex);

    // If current track not found (e.g., filter changed), start from last
    let prevIdxFiltered = currentInFiltered >= 0
        ? (currentInFiltered - 1 + list.length) % list.length
        : list.length - 1;

    const targetBeat = list[prevIdxFiltered];
    const targetIndexInData = currentData.indexOf(targetBeat);
    if (targetIndexInData >= 0) {
        playBeat(targetIndexInData);
    }
}

// Next beat
function nextBeat() {
    // Use filtered list for navigation
    const list = filteredBeats && filteredBeats.length ? filteredBeats : currentData;
    if (!list.length) return; // nothing to play

    // Find current position within the filtered list
    const currentInFiltered = list.findIndex(b => currentData.indexOf(b) === currentBeatIndex);

    // If current track not found (e.g., filter changed), start from first
    let nextIdxFiltered = currentInFiltered >= 0
        ? (currentInFiltered + 1) % list.length
        : 0;

    const targetBeat = list[nextIdxFiltered];
    const targetIndexInData = currentData.indexOf(targetBeat);
    if (targetIndexInData >= 0) {
        playBeat(targetIndexInData);
    }
}

// Update play button icon
function updatePlayButton() {
    const icon = playBtn.querySelector('i');
    icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
}

// Update progress bar
function updateProgress() {
    if (audioElement.duration) {
        const progressPercent = (audioElement.currentTime / audioElement.duration) * 100;
        progress.style.width = progressPercent + '%';
        currentTime.textContent = formatTime(audioElement.currentTime);
    }
}

// Update duration display
function updateDuration() {
    duration.textContent = formatTime(audioElement.duration);
}

// Seek audio
function seekAudio(e) {
    if (audioElement.duration) {
        const rect = progressBar.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        const clickPercent = clickX / width;
        audioElement.currentTime = clickPercent * audioElement.duration;
    }
}

// Update volume
function updateVolume() {
    audioElement.volume = volumeSlider.value / 100;
}

// Filter beats
function filterBeats() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter ? categoryFilter.value : '';
    
    filteredBeats = currentData.filter(beat => {
        const matchesSearch = beat.name.toLowerCase().includes(searchTerm);
        const inDarkFolder = typeof beat.file === 'string' && beat.file.startsWith('Dark Boom Bap/');
        const matchesCategory = !selectedCategory
            || beat.genre === selectedCategory
            || (selectedCategory === 'dark-boom-bap' && inDarkFolder);
        return matchesSearch && matchesCategory;
    });
    applySort();
    renderBeats();
}

// Apply sorting to filteredBeats based on currentSort
function applySort() {
    switch (currentSort) {
        case 'random':
            // Fisher-Yates shuffle (in-place)
            for (let i = filteredBeats.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filteredBeats[i], filteredBeats[j]] = [filteredBeats[j], filteredBeats[i]];
            }
            break;
        case 'az':
            filteredBeats.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'za':
            filteredBeats.sort((a, b) => b.name.localeCompare(a.name));
            break;
        case 'newest':
            filteredBeats.sort((a, b) => (ADDED_AT.get(b.file) || 0) - (ADDED_AT.get(a.file) || 0));
            break;
        case 'oldest':
            filteredBeats.sort((a, b) => (ADDED_AT.get(a.file) || 0) - (ADDED_AT.get(b.file) || 0));
            break;
        case 'default':
        default:
            // Keep original order as defined in currentData
            filteredBeats.sort((a, b) => currentData.indexOf(a) - currentData.indexOf(b));
            break;
    }
}

// Toggle between beats and ideas mode
function toggleMode() {
    // Stop current playback and reset player state FIRST
    if (isPlaying) {
        audioElement.pause();
        isPlaying = false;
    }
    
    // Reset audio element completely
    audioElement.src = '';
    audioElement.load();
    
    // Cancel any in-flight duration metadata loads and clear pending queue
    durationQueue.length = 0;
    pendingDurationAudios.forEach(a => {
        try {
            // Best-effort abort
            a.src = '';
            a.load();
        } catch (_) {}
    });
    pendingDurationAudios.clear();
    
    // Reset player state
    currentBeatIndex = -1; // Reset to -1 to ensure fresh start
    updatePlayButton();
    updateBeatCards();
    
    // Update mode and data
    currentMode = modeSwitch.checked ? 'ideas' : 'beats';
    currentData = currentMode === 'beats' ? beats : ideasData;
    
    // Update header text
    updateHeaderText();
    
    // Update filter options
    updateCategoryFilter();
    
    // Reset filters and render
    searchInput.value = '';
    if (categoryFilter) categoryFilter.value = '';
    filteredBeats = [...currentData];
    applySort();
    // Reset observers and re-render in batches
    createObservers();
    renderBeats();
    
    // Update track info
    currentTrack.textContent = currentMode === 'beats' ? 'Select a beat to play' : 'Select an idea to play';
    
    // Force audio element to be ready for new mode
    setTimeout(() => {
        if (audioElement) {
            audioElement.load();
        }
    }, 100);
}

// Update header text based on mode
function updateHeaderText() {
    if (genreHeader) {
        genreHeader.textContent = currentMode === 'beats' ? 'Genre' : 'Month';
    }
}

// Open search overlay
function openSearch() {
    searchOverlay.classList.add('active');
    setTimeout(() => {
        searchInput.focus();
    }, 300);
}

// Close search overlay
function closeSearch() {
    searchOverlay.classList.remove('active');
    // Don't clear search input to maintain search state
}

// Open Download modal
function openDownloadModal() {
    if (!downloadModal) return;
    downloadModal.classList.add('active');
    downloadModal.setAttribute('aria-hidden', 'false');
    // Focus email input after small delay to allow animation
    setTimeout(() => { if (downloadEmail) downloadEmail.focus(); }, 150);
}

// Close Download modal
function closeDownloadModal() {
    if (!downloadModal) return;
    downloadModal.classList.remove('active');
    downloadModal.setAttribute('aria-hidden', 'true');
}

// Validate email string
function isValidEmail(email) {
    if (!email) return false;
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

// Handle Get my Beat button
async function handleGetBeatClick() {
    const email = (downloadEmail && downloadEmail.value || '').trim();
    const consent = downloadConsent ? downloadConsent.checked : false;
    if (!isValidEmail(email)) {
        alert('Please enter a valid email address.');
        if (downloadEmail) downloadEmail.focus();
        return;
    }
    if (!consent) {
        alert('Please accept promotional emails.');
        return;
    }

    // Disable button while sending
    const originalText = getBeatBtn ? getBeatBtn.textContent : '';
    if (getBeatBtn) {
        getBeatBtn.disabled = true;
        getBeatBtn.textContent = 'Sending...';
    }

    try {
        const beat = currentData && currentData[currentBeatIndex];
        const beatName = beat && beat.name ? beat.name : 'selected';
        const resp = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email,beatName }),
            mode: 'cors',
        });
        const text = await resp.text();
        if (!resp.ok) {
            throw new Error(text || `Request failed (${resp.status})`);
        }

        alert(`Success! ${text || 'Email saved.'}\nThe beat "${beatName}" will be sent to your email.`);
        closeDownloadModal();
    } catch (err) {
        console.error('Error saving email:', err);
        alert(`There was a problem saving your email.\n${(err && err.message) || err}`);
    } finally {
        if (getBeatBtn) {
            getBeatBtn.disabled = false;
            getBeatBtn.textContent = originalText || 'Get my Beat';
        }
    }
}

// Update category filter options
function updateCategoryFilter() {
    if (!categoryFilter) return;
    
    if (currentMode === 'beats') {
        categoryFilter.innerHTML = `
            <option value="">All Genres</option>
            <option value="boom-bap">Boom Bap</option>
            <option value="dark-boom-bap">Dark Boom Bap</option>
            <option value="trap">Trap</option>
            <option value="drill">Drill</option>
            <option value="reggaeton">Reggaeton</option>
            <option value="rage">Rage</option>
            <option value="electronic">Electronic</option>
            <option value="rock">Rock</option>
        `;
    } else {
        categoryFilter.innerHTML = `
            <option value="">All Months</option>
            <option value="agosto">Agosto</option>
        `;
    }
}

// Update beat count (removed - no longer needed)

// Update playing state visual indicators
function updatePlayingState() {
    updateBeatCards();
}

// Update beat rows visual state
function updateBeatCards() {
    const beatRows = document.querySelectorAll('.beat-row');
    beatRows.forEach((row, index) => {
        const beatIndex = currentData.indexOf(filteredBeats[index]);
        if (beatIndex === currentBeatIndex && isPlaying) {
            row.classList.add('playing');
            const playBtn = row.querySelector('.beat-play-btn i');
            playBtn.className = 'fas fa-pause';
        } else {
            row.classList.remove('playing');
            const playBtn = row.querySelector('.beat-play-btn i');
            playBtn.className = 'fas fa-play';
        }
    });
}

// Format time in MM:SS
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    switch(e.code) {
        case 'Space':
            e.preventDefault();
            togglePlay();
            break;
        case 'ArrowLeft':
            e.preventDefault();
            previousBeat();
            break;
        case 'ArrowRight':
            e.preventDefault();
            nextBeat();
            break;
    }
});

// Update audio element events
audioElement.addEventListener('play', () => {
    isPlaying = true;
    updatePlayButton();
    updateBeatCards();
});

audioElement.addEventListener('pause', () => {
    isPlaying = false;
    updatePlayButton();
    updateBeatCards();
});

// If the script loads after DOMContentLoaded (e.g., when injected dynamically),
// initialize immediately to avoid the app getting stuck on "Loading beats...".
if (document.readyState !== 'loading') {
    try {
        renderBeats();
        setupEventListeners();
        if (loading) loading.style.display = 'none';
    } catch (e) {
        console.error('Post-load init error:', e);
    }
}
